<body>
  <p id="time"></p>
  </body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script>
const synth = new Tone.PolySynth().toDestination()

// collection of chords
const chords = [
  ['E3', 'G#3', 'B3', 'D4'],
  ['A3', 'C3', 'E3', 'A4']
]
let lastSecond = -1 // this is to "gate" the conditional below
let playedNote // we'll use this to keep track of the note we played
let chordIndex = 0 // which chord in the collection
let noteIndex = 3 // ******* which note in the chord (try each person setting a different noteIndex to start with)
let volumes = [0, 5]
let volumeIndex = 0
let timer = 0
let otherlastsecond = -1 // this is to "gate" the conditional below
let runReverb = false

const wave = createWaveform()
const spec = createSpectrum({ range: [20, 7040] })

const osc = new Tone.Oscillator({
  frequency: 'A2',
  type: 'custom',
  volume: -5,
  // partials: [0, 0, 0, 0, 0, 0, 0, 0]
  partials: [0, 0, 0, 0, 0, 0, 0, 0]
}).toDestination()
const reverb = new Tone.Reverb(3).toDestination()

osc.connect(wave)
osc.connect(spec)

function play (e) {
  if (e.chl === 41) {
    if (e.val === 127) osc.start()
    else osc.stop()
  }
}

function updatePartials (e) {
  if (e.chl >= 0 && e.chl < osc.partialCount) {
    const i = e.chl
    const p = [...osc.partials]
    // console.log(osc.partials)
    p[i] = nn.map(e.val, 0, 127, 0, 1)
    osc.set({ partials: p })
  }
}

// function updateFreq(e) {
//     if (e.chl === 16){
//         f = nn.map(e.val, 0, 127, 110, 440)
//         osc.set({frequency: f})
//     }
// }

function connectWithReverb() {
    osc.disconnect();
    osc.connect(reverb);
    osc.toDestination()
}

// Function to bypass reverb and connect Oscillator â†’ Destination
function bypassReverb() {
    osc.disconnect(); // Remove previous connections
    osc.toDestination();
}

// osc.connect(reverb);
function syncClock () {
  window.requestAnimationFrame(syncClock)
  const d = new Date()
  const s = d.getSeconds() 
  console.log(s)

  // something to count the seconds
  if (s !== lastSecond){
    // everything in here runs once per second
    lastSecond = s
    timer ++
    // connectWithReverb()

    // clock
    document.getElementById("time").textContent = "Time elapsed: " + timer + ' | Clock: ' + lastSecond;


    // every 4 seconds switch chord
    // if (s % 4 === 0) {
    //   chordIndex++

    //   const ci = chordIndex % chords.length
    //   const note = chords[ci][noteIndex]
    //   osc.set({frequency: note})
    //   // console.log(chordIndex)
    // } 

    // every 10 seconds mess with volume
    if (s % 10 === 0) {
      volumeIndex ++
      const vol_i = volumeIndex % volumes.length

      osc.set({volume: volumes[vol_i]})
    }

    // at 15 seconds add reverb
    if (s === 15){
      runReverb = true
    }

    // run reverb continuously (fun effect)
    if (runReverb){
      connectWithReverb()
    }
    else{
      bypassReverb()
    }
    if (runReverb){
      reverb.set({ wet: (s-10) /10 })
    }
    if (s === 59){
      runReverb = false
    }
    
  }
}

nn.create('button')
  .content('start')
  .addTo('body')
  .on('click', syncClock)


osc.connect(wave)
osc.connect(spec)

nn.MIDI(updatePartials)
nn.MIDI(play)
// nn.MIDI(updateFreq)




</script>